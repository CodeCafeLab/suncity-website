name: Deploy Suncity Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 72.60.218.240
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "ðŸš€ Deploying Suncity Website..."

            APP_DIR="/var/www/suncity-website"
            REPO_URL="https://github.com/CodeCafeLab/suncity-website.git"

            if [ ! -d "$APP_DIR" ]; then
              echo "ðŸ“ Directory missing â€” cloning repo..."
              git clone "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "ðŸ”„ Forcing Git remote to HTTPS"
            git remote set-url origin "$REPO_URL"

            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin main --tags
            git reset --hard origin/main
            git clean -fd

            echo "ðŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps

            echo "ðŸ—ï¸ Building Next.js app..."
            NODE_ENV=production npm run build

            echo "ðŸ” Restarting PM2..."
            if pm2 describe suncity-website >/dev/null 2>&1; then
              pm2 reload suncity-website --update-env
            else
              pm2 start "npm run start" --name suncity-website
            fi

            pm2 save
            echo "ðŸŽ¯ Suncity Website Deployed Successfully!"
